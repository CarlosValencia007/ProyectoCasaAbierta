<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Classroom AI - Test Frontend</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #764ba2;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #764ba2;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        input[type="text"],
        input[type="email"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input[type="file"] {
            display: block;
            margin-top: 5px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success {
            border-left: 4px solid #4caf50;
            background: #e8f5e9;
        }
        
        .error {
            border-left: 4px solid #f44336;
            background: #ffebee;
        }
        
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
        }
        
        .status.online {
            background: #4caf50;
        }
        
        .status.offline {
            background: #f44336;
        }
        
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .student-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .student-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        #video, #enrollVideo {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .camera-section {
            text-align: center;
        }
        
        canvas {
            display: none;
        }
        
        #enrollPreview {
            max-width: 320px;
            border: 2px solid #667eea;
            border-radius: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="status" class="status offline">Backend: Conectando...</div>
    
    <div class="container">
        <h1>üéì Smart Classroom AI - Test Interface</h1>
        
        <!-- SECTION 1: ENROLLMENT -->
        <div class="section">
            <h2>üìù 1. Registrar Estudiante</h2>
            <div class="form-group">
                <label>ID del Estudiante:</label>
                <input type="text" id="studentId" placeholder="Ej: 2024001">
            </div>
            <div class="form-group">
                <label>Nombre Completo:</label>
                <input type="text" id="studentName" placeholder="Ej: Juan P√©rez">
            </div>
            <div class="form-group">
                <label>Email (opcional):</label>
                <input type="email" id="studentEmail" placeholder="Ej: juan@example.com">
            </div>
            <div class="form-group">
                <label>Foto del Estudiante:</label>
                <div class="camera-section">
                    <video id="enrollVideo" autoplay style="display:none;"></video>
                    <canvas id="enrollCanvas" style="display:none;"></canvas>
                    <img id="enrollPreview" style="display:none; max-width: 320px; border-radius: 10px; margin: 10px 0;">
                    <br>
                    <button onclick="startEnrollCamera()">üì∑ Activar C√°mara</button>
                    <button onclick="captureEnrollPhoto()" id="captureEnrollBtn" style="display:none;">üì∏ Capturar Foto</button>
                    <button onclick="resetEnrollPhoto()" id="resetEnrollBtn" style="display:none;">üîÑ Tomar Otra</button>
                    <p style="margin: 10px 0;">o</p>
                    <input type="file" id="studentPhoto" accept="image/*" onchange="handleFileUpload()">
                </div>
            </div>
            <button onclick="enrollStudent()">Registrar Estudiante</button>
            <div id="enrollResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- SECTION 2: CREATE CLASS -->
        <div class="section">
            <h2>üè´ 2. Crear Sesi√≥n de Clase</h2>
            <div class="form-group">
                <label>Nombre de la Clase:</label>
                <input type="text" id="className" placeholder="Ej: Matem√°ticas 101">
            </div>
            <div class="form-group">
                <label>Fecha:</label>
                <input type="date" id="classDate" value="2026-01-04">
            </div>
            <div class="form-group">
                <label>Hora de Inicio:</label>
                <input type="time" id="classStartTime" value="10:00">
            </div>
            <div class="form-group">
                <label>Hora de Fin:</label>
                <input type="time" id="classEndTime" value="12:00">
            </div>
            <div class="form-group">
                <label>Instructor (opcional):</label>
                <input type="text" id="instructor" placeholder="Ej: Prof. Garc√≠a">
            </div>
            <div class="form-group">
                <label>Aula (opcional):</label>
                <input type="text" id="room" placeholder="Ej: Aula 301">
            </div>
            <button onclick="createClass()">Crear Sesi√≥n de Clase</button>
            <div id="classResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- SECTION 3: ATTENDANCE -->
        <div class="section">
            <h2>‚úÖ 3. Tomar Asistencia</h2>
            <div class="form-group">
                <label>Class ID:</label>
                <input type="text" id="classId" placeholder="Pega aqu√≠ el class_id de la Secci√≥n 2">
                <small style="color: #666;">Copia el class_id del resultado de "Crear Sesi√≥n de Clase"</small>
            </div>
            <div class="camera-section">
                <video id="video" autoplay></video>
                <canvas id="canvas"></canvas>
                <br>
                <button onclick="startCamera()">üì∑ Activar C√°mara de Asistencia</button>
                <button onclick="captureAttendance()">üì∏ Capturar para Verificaci√≥n</button>
                <button onclick="verifyAttendance()">Verificar Asistencia</button>
            </div>
            <div id="attendanceResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- SECTION 4: EMOTIONS -->
        <div class="section">
            <h2>üòä 4. Analizar Emociones</h2>
            <button onclick="analyzeEmotion()">Analizar Emoci√≥n (usa la c√°mara)</button>
            <div id="emotionResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- SECTION 5: REPORTS -->
        <div class="section">
            <h2>üìä 5. Reportes</h2>
            <button onclick="getAttendanceReport()">Ver Reporte de Asistencia</button>
            <button onclick="getEmotionSummary()">Ver Resumen Emocional</button>
            <div id="reportResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- SECTION 6: STUDENTS LIST -->
        <div class="section">
            <h2>üë• 6. Estudiantes Registrados</h2>
            <button onclick="loadStudents()">Cargar Estudiantes</button>
            <div id="studentsList" class="student-grid"></div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8080/api/v1';
        let currentClassId = null;
        let stream = null;
        let enrollStream = null;
        let capturedEnrollPhoto = null;
        let capturedAttendanceImage = null;
        
        // Check backend health on load
        async function checkHealth() {
            const statusDiv = document.getElementById('status');
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 segundos timeout
                
                const response = await fetch('http://localhost:8080/health', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusDiv.textContent = 'Backend: Online ‚úì';
                    statusDiv.className = 'status online';
                    console.log('‚úÖ Backend connected:', data);
                } else {
                    statusDiv.textContent = 'Backend: Issues';
                    statusDiv.className = 'status offline';
                }
            } catch (error) {
                console.error('‚ùå Backend connection failed:', error);
                statusDiv.textContent = 'Backend: Offline ‚úó';
                statusDiv.className = 'status offline';
            }
        }
        
        // Helper: file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // Helper: canvas to base64
        function canvasToBase64(canvas) {
            return canvas.toDataURL('image/jpeg').split(',')[1];
        }
        
        // Enrollment Camera Functions
        async function startEnrollCamera() {
            try {
                // Solicitar permisos de c√°mara
                enrollStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                });
                
                const video = document.getElementById('enrollVideo');
                video.srcObject = enrollStream;
                video.style.display = 'block';
                
                // Esperar a que el video est√© listo
                await video.play();
                
                document.getElementById('captureEnrollBtn').style.display = 'inline-block';
                alert('‚úÖ C√°mara activada correctamente');
            } catch (error) {
                console.error('Camera error:', error);
                alert('‚ùå Error al acceder a la c√°mara: ' + error.message + '\n\nAseg√∫rate de:\n- Dar permisos de c√°mara al navegador\n- Usar HTTPS o localhost\n- Tener una c√°mara conectada');
            }
        }
        
        function captureEnrollPhoto() {
            const video = document.getElementById('enrollVideo');
            const canvas = document.getElementById('enrollCanvas');
            const preview = document.getElementById('enrollPreview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // Guardar la captura
            capturedEnrollPhoto = canvasToBase64(canvas);
            
            // Mostrar preview
            preview.src = canvas.toDataURL('image/jpeg');
            preview.style.display = 'block';
            
            // Ocultar video y mostrar bot√≥n de reset
            video.style.display = 'none';
            document.getElementById('captureEnrollBtn').style.display = 'none';
            document.getElementById('resetEnrollBtn').style.display = 'inline-block';
            
            // Detener stream
            if (enrollStream) {
                enrollStream.getTracks().forEach(track => track.stop());
            }
        }
        
        function resetEnrollPhoto() {
            capturedEnrollPhoto = null;
            document.getElementById('enrollPreview').style.display = 'none';
            document.getElementById('resetEnrollBtn').style.display = 'none';
            document.getElementById('studentPhoto').value = '';
        }
        
        function handleFileUpload() {
            // Si se sube un archivo, limpiar la foto capturada
            capturedEnrollPhoto = null;
            document.getElementById('enrollPreview').style.display = 'none';
            document.getElementById('enrollVideo').style.display = 'none';
            document.getElementById('captureEnrollBtn').style.display = 'none';
            document.getElementById('resetEnrollBtn').style.display = 'none';
            if (enrollStream) {
                enrollStream.getTracks().forEach(track => track.stop());
            }
        }
        
        // 1. Enroll Student
        async function enrollStudent() {
            const studentId = document.getElementById('studentId').value;
            const name = document.getElementById('studentName').value;
            const email = document.getElementById('studentEmail').value;
            const photoFile = document.getElementById('studentPhoto').files[0];
            const resultDiv = document.getElementById('enrollResult');
            
            if (!studentId || !name) {
                alert('Por favor completa el ID y nombre del estudiante');
                return;
            }
            
            if (!photoFile && !capturedEnrollPhoto) {
                alert('Por favor captura o sube una foto del estudiante');
                return;
            }
            
            try {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result';
                resultDiv.textContent = 'Procesando...';
                
                let base64Image;
                if (capturedEnrollPhoto) {
                    // Usar foto capturada
                    base64Image = capturedEnrollPhoto;
                } else {
                    // Usar archivo subido
                    base64Image = await fileToBase64(photoFile);
                }
                
                const response = await fetch(`${API_BASE}/enrollment/enroll`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        student_id: studentId,
                        name: name,
                        email: email || null,
                        image_base64: base64Image
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = JSON.stringify(result, null, 2);
                    // Limpiar formulario
                    document.getElementById('studentId').value = '';
                    document.getElementById('studentName').value = '';
                    document.getElementById('studentEmail').value = '';
                    resetEnrollPhoto();
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'Error: ' + result.message;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }
        
        // 2. Create Class
        async function createClass() {
            const className = document.getElementById('className').value;
            const classDate = document.getElementById('classDate').value;
            const startTime = document.getElementById('classStartTime').value;
            const endTime = document.getElementById('classEndTime').value;
            const instructor = document.getElementById('instructor').value || 'No especificado';
            const room = document.getElementById('room').value || 'No especificado';
            const resultDiv = document.getElementById('classResult');
            
            if (!className || !classDate || !startTime || !endTime) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            
            try {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result';
                resultDiv.textContent = 'Creando sesi√≥n de clase...';
                
                const response = await fetch(`${API_BASE}/classes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        class_name: className,
                        session_date: classDate,
                        start_time: startTime,
                        end_time: endTime,
                        instructor: instructor,
                        room: room
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentClassId = result.class_id;
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>‚úÖ Sesi√≥n de Clase creada exitosamente!</strong><br><br>
                        <strong>üÜî Class ID:</strong> ${result.class_id}<br>
                        <strong>üìö Clase:</strong> ${result.class_name}<br>
                        <strong>üìÖ Fecha:</strong> ${result.session_date}<br>
                        <strong>‚è∞ Horario:</strong> ${result.start_time} - ${result.end_time}<br>
                        <strong>üë®‚Äçüè´ Instructor:</strong> ${result.instructor || 'No especificado'}<br>
                        <strong>üö™ Aula:</strong> ${result.room || 'No especificada'}<br><br>
                        <strong style="color: #2196F3;">üìã Copia el Class ID y p√©galo en la Secci√≥n 3 para tomar asistencia</strong>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'Error: ' + result.message;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }
        
        // 3. Start Camera
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                document.getElementById('video').srcObject = stream;
                alert('‚úÖ C√°mara activada. Haz click en "Capturar para Verificaci√≥n" cuando est√©s listo.');
            } catch (error) {
                alert('Error al acceder a la c√°mara: ' + error.message);
            }
        }
        
        function captureAttendance() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            if (!stream) {
                alert('Primero activa la c√°mara con "Activar C√°mara de Asistencia"');
                return;
            }
            
            // Capture frame
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedAttendanceImage = canvas.toDataURL('image/jpeg');
            alert('‚úÖ Foto capturada! Ahora haz click en "Verificar Asistencia"');
        }
        
        // 3. Verify Attendance
        async function verifyAttendance() {
            const classId = document.getElementById('classId').value;
            const resultDiv = document.getElementById('attendanceResult');
            
            if (!classId) {
                alert('Por favor ingresa el Class ID de la Secci√≥n 2');
                return;
            }
            
            if (!capturedAttendanceImage) {
                alert('Primero captura una foto con el bot√≥n "Capturar para Verificaci√≥n"');
                return;
            }
            
            try {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result';
                resultDiv.textContent = 'Verificando asistencia...';
                
                const response = await fetch(`${API_BASE}/attendance/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        class_id: classId,
                        image_base64: capturedAttendanceImage
                    })
                });
                
                const result = await response.json();
                
                // Check if response is successful (HTTP 200+) AND backend reports success
                if (response.ok && result.success && result.data) {
                    const data = result.data;
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>‚úÖ Asistencia registrada exitosamente!</strong><br><br>
                        <strong>üë§ Estudiante:</strong> ${data.student_name} (${data.student_id})<br>
                        <strong>üéØ Confianza:</strong> ${(data.confidence * 100).toFixed(2)}%<br>
                        <strong>‚è∞ Hora:</strong> ${new Date(data.timestamp).toLocaleString('es-ES')}<br>
                        <strong>üìö Class ID:</strong> ${classId}<br>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    const errorMsg = result.message || result.detail || 'Estudiante no reconocido';
                    resultDiv.textContent = '‚ùå ' + errorMsg;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Error: ' + error.message;
            }
        }
        
        // 4. Analyze Emotion
        async function analyzeEmotion() {
            if (!currentClassId) {
                alert('Primero debes crear una clase');
                return;
            }
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const resultDiv = document.getElementById('emotionResult');
            
            if (!stream) {
                alert('Primero inicia la c√°mara');
                return;
            }
            
            try {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result';
                resultDiv.textContent = 'Analizando emoci√≥n...';
                
                // Capture frame
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const base64Image = canvasToBase64(canvas);
                
                const response = await fetch(`${API_BASE}/emotions/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_base64: base64Image,
                        class_id: currentClassId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = JSON.stringify(result, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'Error: ' + result.message;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }
        
        // 5. Get Attendance Report
        async function getAttendanceReport() {
            if (!currentClassId) {
                alert('Primero debes crear una clase');
                return;
            }
            
            const resultDiv = document.getElementById('reportResult');
            
            try {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result';
                resultDiv.textContent = 'Cargando reporte...';
                
                const response = await fetch(`${API_BASE}/attendance/report/${currentClassId}`);
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = JSON.stringify(result, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'Error: ' + result.message;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }
        
        // 5. Get Emotion Summary
        async function getEmotionSummary() {
            if (!currentClassId) {
                alert('Primero debes crear una clase');
                return;
            }
            
            const resultDiv = document.getElementById('reportResult');
            
            try {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result';
                resultDiv.textContent = 'Cargando resumen...';
                
                const response = await fetch(`${API_BASE}/emotions/class-summary/${currentClassId}`);
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = JSON.stringify(result, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'Error: ' + result.message;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }
        
        // 6. Load Students
        async function loadStudents() {
            const listDiv = document.getElementById('studentsList');
            
            try {
                listDiv.innerHTML = 'Cargando...';
                
                const response = await fetch(`${API_BASE}/enrollment/students`);
                const result = await response.json();
                
                if (result.success && result.data.students.length > 0) {
                    listDiv.innerHTML = result.data.students.map(student => `
                        <div class="student-card">
                            ${student.photo_url ? `<img src="${student.photo_url}" alt="${student.name}">` : ''}
                            <h3>${student.name}</h3>
                            <p>ID: ${student.student_id}</p>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<p>No hay estudiantes registrados</p>';
                }
            } catch (error) {
                listDiv.innerHTML = '<p>Error al cargar estudiantes: ' + error.message + '</p>';
            }
        }
        
        // Check health on load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina cargada, iniciando verificaci√≥n de backend...');
            checkHealth();
            setInterval(checkHealth, 10000); // Check every 10 seconds
        });
    </script>
</body>
</html>
